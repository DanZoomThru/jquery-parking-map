/**
*
*	@module pwMap
*	@author ParkWhiz.com
*	jquery.parkingmap.js : v1.0.2
*	https://github.com/ParkWhiz/jquery-parking-map
*	Copyright (c) 2014 ParkWhiz, Inc.
*	MIT licensed
*
*/
(function(e){if(!e.pwMap){e.pwMap={}}e.pwMap.parkingMap=function(t,n){var r=this,i="M/D/YYYY",s="h:mma";r.$el=e(t);r.el=t;r.$el.data("pwMap.parkingMap",r);r.listings=[];r.searchOptions={};r._iconCache={};r.$el.append('<a href="http://www.parkwhiz.com/" target="_blank" title="Powered by ParkWhiz" class="powered-by-pw">Powered by <span>ParkWhiz</span></a>');r.settings={HDPI:window.retina||window.devicePixelRatio>1};if(r.settings.HDPI){e.extend(r.settings,{MAIN_SPRITE:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/parkwhiz-sprite@2x.png",EXTENDED_SPRITE_101_300:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-101-300@2x.png",EXTENDED_SPRITE_301_500:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-301-500@2x.png",EXTENDED_SPRITE_501_700:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-501-700@2x.png",EXTENDED_SPRITE_701_900:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-701-900@2x.png",EXTENDED_SPRITE_901_999:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-901-999@2x.png"})}else{e.extend(r.settings,{MAIN_SPRITE:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/parkwhiz-sprite.png",EXTENDED_SPRITE_101_300:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-101-300.png",EXTENDED_SPRITE_301_500:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-301-500.png",EXTENDED_SPRITE_501_700:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-501-700.png",EXTENDED_SPRITE_701_900:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-701-900.png",EXTENDED_SPRITE_901_999:"https://dbmgns9xjyk0b.cloudfront.net/parkingmapjs/images/map-price-sprite-extended-901-999.png"})}r.init=function(){r.options=e.extend({},e.pwMap.parkingMap.defaultOptions,n);r.options.defaultTime=e.extend({},e.pwMap.parkingMap.defaultOptions.defaultTime,n.defaultTime);r.options.location=e.extend({},e.pwMap.parkingMap.defaultOptions.location,n.location);r.options.mapOptions=e.extend({},e.pwMap.parkingMap.defaultOptions.mapOptions,n.mapOptions);r.options.location.center=e.extend({},e.pwMap.parkingMap.defaultOptions.location.center,n.location.center);var t=new Date,o=(t.getTimezoneOffset()-300)*-60;if(r.options.defaultTime.start){r.options.defaultTime.start+=o}if(r.options.defaultTime.end){r.options.defaultTime.end+=o}r.$el.addClass("parkwhiz-widget-container clearfix").css("width",r.options.width).empty();e.each(r.options.modules,function(e,t){r.$el.append(r.options.moduleMarkup[t])});r.$map=r.$el.find(".parking-map-widget-container");var u=new google.maps.Size(38,33);if(r.options.showPrice===false){u=new google.maps.Size(22,37)}r._iconMeta={size:u,shadow:{url:r.settings.MAIN_SPRITE,size:new google.maps.Size(53,23),origin:r._spriteCoordinates("number_shadow"),anchor:new google.maps.Point(20,23),scaledSize:null}};if(r.settings.HDPI){r._iconMeta.shadow.scaledSize=new google.maps.Size(477,1098)}r.searchOptions.key=r.options.parkwhizKey;if(r.options.monthly){r.searchOptions.monthly=1}if(_.contains(r.options.modules,"time_picker")){var a=moment.unix(r.options.defaultTime.start).add("m",15);var f=moment.unix(r.options.defaultTime.end).add("m",15);if(a.minutes()>=30){a.minutes(30)}else{a.minutes(0)}if(f.minutes()>=30){f.minutes(30)}else{f.minutes(0)}if(moment().isDST()){a=a.subtract("h",1);f=f.subtract("h",1)}r.$el.find(".start.time").val(a.format(s));r.$el.find(".end.time").val(f.format(s));r.$el.find(".start.date").val(a.format(i));r.$el.find(".end.date").val(f.format(i));r.searchOptions.start=a.unix();r.searchOptions.end=f.unix();r.$el.find("input.date").each(function(){var t=e(this);if(!t.attr("placeholder")){t.attr("placeholder","date")}var n={format:"m/d/yyyy",autoclose:true};if(t.hasClass("start")||t.hasClass("end")){t.on("change changeDate",t.update_datepair)}t.datepicker(n)});r.$el.find("input.time").each(function(){var t=e(this);if(!t.attr("placeholder")){t.attr("placeholder","time")}var n={showDuration:true,className:"parkwhiz-widget-timepicker",timeFormat:"g:ia",scrollDefaultNow:true};if(t.hasClass("start")||t.hasClass("end")){t.on("change",t.update_datepair)}t.timepicker(n)});var l=r.$el.find(".datepair");l.find("input").each(function(){var t=e(this);if(t.hasClass("start")||t.hasClass("end")){t.on("change",function(){var e=t.closest(".datepair");var n=e.find(".datepair-start");var i=e.find(".datepair-end");var s=moment(n.find(".date").val()+" "+n.find(".time").val(),"MM-DD-YYYY h:mma");var u=moment(i.find(".date").val()+" "+i.find(".time").val(),"MM-DD-YYYY h:mma");if(moment().isDST()){s=s.subtract("h",1);u=u.subtract("h",1)}r.searchOptions.start=s.unix()+o;r.searchOptions.end=u.unix()+o;r._clearMap();r._getListings(r._putListingsOnMap)})}});l.each(r.init_datepair)}r._createMap()};r._clearMap=function(){r.$el.find("#parking-popup").remove();r.$el.find(".psf").remove();r.$el.find(".location-place").html("");r.$map.gmap3("clear")};r._getListings=function(t){var s=r.options.location.venue,o=r.options.location.event,u=r.options.location.destination,a=r.searchOptions,f=[];r.listings=[];if(!e.isArray(s)){s=[s]}if(!e.isArray(o)){o=[o]}if(!e.isArray(u)){u=[u]}var l,c=[];e.each(s.concat(o),function(e,t){l=a;if(!n.defaultTime){delete l.start;delete l.end}c.push({uri:t,options:l})});var h;e.each(u,function(t,n){h=a;if(e.isPlainObject(n)){if(n.lat&&n.lng){h.lat=n.lat;h.lng=n.lng}else if(n.destination){h.destination=n.destination}}else{h.destination=n}c.push({uri:"search",options:h})});if(c.length===0){e.each(r.options.location.center,function(e,t){a[e]=t});c.push({uri:"search",options:a})}e.each(c,function(n,s){e.ajax("//api.parkwhiz.com/"+s.uri,{dataType:"jsonp",data:s.options,cache:true,success:function(n){if((_.contains(r.options.modules,"event_list")||!e.isEmptyObject(r.options.location.event))&&_.contains(r.options.modules,"time_picker")){r.$el.find(".parking-timepicker-widget-container .form-help a").attr("href",n.parkwhiz_url)}if(_.isEmpty(r.options.location.center)){var o={map:{options:e.extend({center:[n.lat,n.lng]},r.options.mapOptions)},marker:{}};r.options.location.center={lat:n.lat,lng:n.lng};if(r.options.showLocationMarker){o.marker.latLng=o.map.options.center}o=e.extend(o,r.options.overrideOptions);r.$map.gmap3(o)}if((_.contains(r.options.modules,"event_list")||!e.isEmptyObject(r.options.location.event))&&_.contains(r.options.modules,"time_picker")&&(n.events||n.event_name)){r.$el.find(".datepair, .datepair-end").hide();r.$el.find(".parking-timepicker-widget-container .form-help").html('ParkWhiz passes are valid for the entire event, even if the event runs late. You also have plenty of time before and after to get to and from your car. <strong>However, if you have additional plans be sure to <a href="http://www.parkwhiz.com/" target="_blank" title="ParkWhiz.com">book extra time via the ParkWhiz website &rarr;</a></strong>')}if(n.parking_listings){r.listings=r.listings.concat(n.parking_listings);f.push(n)}if(n.event_name&&_.contains(r.options.modules,"event_list")){r.$el.find(".event_list-mod h2").text("Parking for "+n.event_name)}if(n.events&&_.contains(r.options.modules,"event_list")){var u,a=r.$el.find(".parking-events"),l,h=null,p=null,d=a.find("li.active");if(d.length){p=d.data("event_id")}else if(r.options.location.defaultEvent){p=r.options.location.defaultEvent}r.$el.find(".event_list-mod h2").html(n.num_events+" Upcoming"+(n.num_events>1?" Events":" Event"));a.empty();e.each(n.events,function(t,n){l=e("<li>"+moment(n.start*1e3).format(i)+": <span>"+n.event_name+"</span></li>");l.data("event_id",n.event_id);if(p&&parseInt(n.event_id,10)===parseInt(p,10)){u=n.api_url;l.addClass("active")}a.append(l)});if(!u){u=n.events[0].api_url;a.find("li:first").addClass("active")}delete s.options.start;delete s.options.end;if(r.$el.find(".form-help a").length){h=u.replace("api.parkwhiz.com","www.parkwhiz.com");e(".parking-timepicker-widget-container .form-help a").attr("href",h)}e.ajax(u,{dataType:"jsonp",data:s.options,cache:true,success:function(e){r.$el.find(".location-place").html("");f=[];f.push(e);r.listings=e.parking_listings;if(f.length===c.length){t()}else{if(_.contains(r.options.modules,"parking_locations")){r.$el.find(".location-place").animate({height:40},600,"easeInBack").append("<li><em>Sorry, parking is currently not available....</em></li>")}}}});var v=a.find("li");v.click(function(){r._clearMap();var t=e(this);v.removeClass("active").unbind("click");t.addClass("active");r._createMap()})}if(!n.event_name&&!n.events&&_.contains(r.options.modules,"event_list")){r.$el.find(".event_list-mod").remove()}if(f.length===c.length){t()}else{if(_.contains(r.options.modules,"parking_locations")){r.$el.find(".location-place").animate({height:40},600,"easeInBack").append("<li><em>Sorry, parking is currently not available....</em></li>")}}}})})};r._createMap=function(){r.$map.width(r.options.width);r.$map.height(r.options.height);var t={options:r.options.mapOptions},n={};if(r.options.location.center.destination){t.address=r.options.location.center.destination;if(r.options.showLocationMarker){n.address=t.address}}else if(r.options.location.center.lat&&r.options.location.center.lng){t.latLng=[r.options.location.center.lat,r.options.location.center.lng];if(r.options.showLocationMarker){n.latLng=t.latLng}}var i=e.extend({},{map:t,marker:n},r.options.overrideOptions);r.$map.gmap3(i);r._getListings(r._putListingsOnMap)};r._putListingsOnMap=function(){var e=r.$el.find(".location-place"),t=[];for(var n=0;n<r.listings.length;n++){if(r.listings[n].price){var i=r._getIcons(r.listings[n].price);if(r.options.additionalMarkers){i.normal=r.options.additionalMarkers}t.push({latLng:[r.listings[n].lat,r.listings[n].lng],data:{listing:r.listings[n],icon:i},options:{icon:i.normal,shadow:r._iconMeta.shadow,visible:true,zIndex:997},tag:"listing"});e.append('<li><a href="'+r.listings[n].parkwhiz_url+'" target="_blank" title="'+r.listings[n].price_formatted+" Parking for "+r.listings[n].location_name+'">'+r.listings[n].address+"</a></li>")}}var s={marker:{values:t,events:{mouseover:function(e,t,n){if(n.data.icon){e.setZIndex(999);e.setIcon(n.data.icon.active)}},mouseout:function(e,t,n){if(n.data.icon){e.setZIndex(998);e.setIcon(n.data.icon.normal)}},click:function(e,t,n){window.open(n.data.listing.parkwhiz_url)}}}};r.$map.gmap3(s)};r._spriteCoordinates=function(e,t){if(e==="p"){if(t==="active"){return new google.maps.Point(56,693)}else{return new google.maps.Point(0,693)}}else if(e==="number_shadow"){return new google.maps.Point(396,23)}else if(e==="p_shadow"){return new google.maps.Point(24,693)}else{var n=parseInt(e)-1;if(n>=1e3){n=999}var r=n%100;var i=Math.floor(n/100);if(i>0){i=(i-1)%2}var s=Math.floor(r/10)*34;if(t==="active"){s+=339}var o=(r%10+10*i)*38;return new google.maps.Point(o,s)}};r._getIcons=function(e){if(!r._iconCache[e]){var t,n;if(e<=100){t=r.settings.MAIN_SPRITE;n=new google.maps.Size(477,1098)}else if(e>100&&e<=300){t=r.settings.EXTENDED_SPRITE_101_300;n=new google.maps.Size(760,680)}else if(e>300&&e<=500){t=r.settings.EXTENDED_SPRITE_301_500;n=new google.maps.Size(760,680)}else if(e>500&&e<=700){t=r.settings.EXTENDED_SPRITE_501_700;n=new google.maps.Size(760,680)}else if(e>700&&e<=900){t=r.settings.EXTENDED_SPRITE_701_900;n=new google.maps.Size(760,680)}else if(e>900){t=r.settings.EXTENDED_SPRITE_901_999;n=new google.maps.Size(380,680)}if(!r.options.showPrice){r._iconCache[e]={normal:{url:t,size:r._iconMeta.size,scaledSize:n,origin:new google.maps.Point(0,693)},active:{url:t,size:r._iconMeta.size,scaledSize:n,origin:new google.maps.Point(56,693)}}}else{r._iconCache[e]={normal:{url:t,size:r._iconMeta.size,scaledSize:n,origin:e===0?new google.maps.Point(380,645):r._spriteCoordinates(e,"normal")},active:{url:t,size:r._iconMeta.size,scaledSize:n,origin:e===0?new google.maps.Point(418,645):r._spriteCoordinates(e,"active")}}}}return r._iconCache[e]};r.init_datepair=function(){var t=e(this);var n=t.find("input.start.date");var r=t.find("input.end.date");var s=moment.duration(0,"days");if(n.length&&r.length){var o=moment(n.val(),i);var u=moment(r.val(),i);s=u.diff(o,"days");t.data("dateDelta",s)}var a=t.find("input.start.time");var f=t.find("input.end.time");if(a.length&&f.length){var l=a.timepicker("getSecondsFromMidnight");var c=f.timepicker("getSecondsFromMidnight");t.data("timeDelta",c-l);if(s<1){f.timepicker("option","minTime",l)}}};e.fn.update_datepair=function(){var t=e(this);var n=t.closest(".datepair");if(t.hasClass("date")){r._update_date_pair(t,n)}else if(t.hasClass("time")){r._update_time_pair(t,n)}};r._update_date_pair=function(e,t){var n=t.find("input.start.date");var r=t.find("input.end.date");if(!n.length||!r.length){return}var s=moment(n.val());var o=moment(r.val());var u=moment.duration(t.data("dateDelta"),"days");if(u&&e.hasClass("start")){var a=s;a.add(u);r.val(a.format(i)).datepicker("update");return}else{var f=o.diff(s,"days");if(f<0){f=0;if(e.hasClass("start")){r.val(s.format(i)).datepicker("update")}}else if(f<1){var l=t.find("input.start.time").val();if(l){t.find("input.end.time").timepicker("option",{minTime:l})}}else{t.find("input.end.time").timepicker("option",{minTime:null})}t.data("dateDelta",f)}};r._update_time_pair=function(e,t){var n={el:t.find("input.start.time")};var r={el:t.find("input.end.time")};if(!n.el.length||!r.el.length){return}n.seconds=n.el.timepicker("getSecondsFromMidnight");r.seconds=r.el.timepicker("getSecondsFromMidnight");if(n.seconds===null||r.seconds===null){return}var s=t.data("timeDelta");var o=t.data("dateDelta");var u=r.seconds-n.seconds;if(e.hasClass("start")){if(!o||o<1){r.el.timepicker("option","minTime",n.seconds)}else{r.el.timepicker("option","minTime",null)}}if(s&&e.hasClass("start")&&u<s){r.seconds=(n.seconds+s)%86400;r.el.timepicker("setTime",r.seconds)}t.data("timeDelta",r.seconds-n.seconds);var a=moment.duration(0,"days");if(r.seconds-n.seconds<=0&&(!s||s>0)){a=moment.duration(1,"days")}else if(r.seconds-n.seconds>0&&s<0&&e.hasClass("end")){a=moment.duration(-1,"days")}var f=t.find(".start.date");var l=t.find(".end.date");if(f.val()&&!l.val()){l.datepicker("setValue",f.val());o=0;t.data("dateDelta",0)}if(a!==0){if(o||o===0){var c=moment(l.val(),i).add(a);l.val(c.format(i)).datepicker("update");t.data("dateDelta",o+a.asDays())}}};r.init()};e.pwMap.parkingMap.defaultOptions={parkwhizKey:"d4c5b1639a3e443de77c43bb4d4bc888",additionalMarkers:false,showLocationMarker:true,showPrice:true,monthly:false,width:"100%",height:"400px",modules:["map","time_picker","parking_locations"],moduleMarkup:{map:'<div class="parking-map-widget-container map-mod mod"></div>',parking_locations:'<div class="parking-locations-widget-container parking_locations-mod mod"><h2>Parking Locations</h2><ul class="location-place parking"></ul></div>',event_list:'<div class="parking-events-widget-container event_list-mod mod"><h2>Events</h2><ul class="parking-events parking"></ul></div>',time_picker:'<div class="parking-timepicker-widget-container time_picker-mod mod"><h2>Timeframe</h2><p class="form-help">Change the start and end times below to when you\'ll need parking.</p><div class="datepair"><div class="datepair-start"><strong>From:</strong><input type="text" class="time start" /> on <input type="text" class="date start" /></div><div class="datepair-end"><strong>To:</strong> <input type="text" class="time end" /> on <input type="text" class="date end" /></div></div></div>'},defaultTime:{start:moment().unix(),end:moment().add("h",8).unix()},location:{center:null,defaultEvent:null,event:[],destination:[],venue:[]},mapOptions:{zoom:14,mapTypeControl:false,panControl:false,scrollwheel:false,streetViewControl:false,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL},styles:[{stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{visibility:"on"},{color:"#60a8f0"},{saturation:50},{lightness:15}]},{featureType:"road",elementType:"geometry.fill",stylers:[{saturation:0},{lightness:30}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{lightness:20}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#7fbf6f"},{lightness:20}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"},{saturation:5},{lightness:5}]},{featureType:"poi.park",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.medical",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.business",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"simplified"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{visibility:"on"},{saturation:30}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"road.local",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"all",elementType:"all",stylers:[{lightness:14}]},{featureType:"transit.line",elementType:"all",stylers:[{visibility:"simplified"},{lightness:35}]},{featureType:"transit.station.rail",elementType:"labels.icon",stylers:[{saturation:-100}]},{featureType:"poi",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"landscape",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"transit.station.bus",elementType:"labels.icon",stylers:[{saturation:-100}]},{featureType:"transit.station.airport",elementType:"labels.icon",stylers:[{saturation:-100}]},{featureType:"road",elementType:"all",stylers:[{visibility:"on"}]}]},overrideOptions:{}};e.fn.pwMap_parkingMap=function(t){return this.each(function(){new e.pwMap.parkingMap(this,t)})}})(jQuery)